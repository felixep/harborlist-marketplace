# HarborList Local Development Environment
# Enhanced setup with all services enabled
# Usage: docker-compose up

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--accesslog=true"
      - "--log.level=INFO"
      - "--serversTransport.insecureSkipVerify=true"
    ports:
      - "80:80"
      - "443:443"
      - "8088:8080" # Traefik dashboard (moved to avoid conflicts)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik-config:/etc/traefik/dynamic:ro
      - ./certs/local:/etc/ssl/certs:ro
    networks:
      - harborlist-local
    labels:
      - "traefik.enable=true"
      # HTTP to HTTPS redirect  
      - "traefik.http.routers.dashboard-http.rule=Host(`traefik.local.harborlist.com`)"
      - "traefik.http.routers.dashboard-http.entrypoints=web"
      - "traefik.http.routers.dashboard-http.middlewares=https-redirect@file"
      # HTTPS router
      - "traefik.http.routers.dashboard-https.rule=Host(`traefik.local.harborlist.com`)"
      - "traefik.http.routers.dashboard-https.entrypoints=websecure"
      - "traefik.http.routers.dashboard-https.tls=true"
      - "traefik.http.routers.dashboard-https.service=api@internal"

  # Frontend development server
  frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/frontend/node_modules
      - /workspace/packages/shared-types/node_modules
    environment:
      - VITE_API_URL=https://local-api.harborlist.com/api
      - VITE_ENVIRONMENT=local
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - backend
    networks:
      - harborlist-local
    labels:
      - "traefik.enable=true"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.frontend-http.rule=Host(`local.harborlist.com`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.middlewares=https-redirect@file"
      # HTTPS router
      - "traefik.http.routers.frontend-https.rule=Host(`local.harborlist.com`)"
      - "traefik.http.routers.frontend-https.entrypoints=websecure"
      - "traefik.http.routers.frontend-https.tls=true"
      - "traefik.http.routers.frontend-https.service=frontend"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.http.services.frontend.loadbalancer.server.scheme=http"

  # Backend API server (Express wrapper for Lambda functions)
  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile.dev
      target: backend
    ports:
      - "3001:3001"
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/backend/node_modules
      - /workspace/packages/shared-types/node_modules
    environment:
      - NODE_ENV=development
      - ENVIRONMENT=local
      - DEPLOYMENT_TARGET=docker
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - S3_ENDPOINT=http://localstack:4566
      - SES_ENDPOINT=http://localstack:4566
      - SMTP_HOST=smtp4dev
      - SMTP_PORT=25
      - SMTP_SECURE=false
      - ACCESS_TOKEN_EXPIRY_SECONDS=86400 # 24 hours for local development
      - FROM_EMAIL=noreply@harborlist.local
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=us-east-1
      - CORS_ORIGINS=https://local.harborlist.com,http://localhost:3000
      - API_BASE_URL=https://local-api.harborlist.com
      - FRONTEND_URL=https://local.harborlist.com
      - LISTINGS_TABLE=harborlist-listings
      - USERS_TABLE=harborlist-users
      - MEDIA_BUCKET=harborlist-media-local
      - THUMBNAILS_BUCKET=harborlist-thumbnails-local
      - REVIEWS_TABLE=harborlist-reviews
      - SESSIONS_TABLE=harborlist-sessions
      - LOGIN_ATTEMPTS_TABLE=harborlist-login-attempts
      - AUDIT_LOGS_TABLE=harborlist-audit-logs
      - COGNITO_ENDPOINT=http://localstack:4566
      - IS_LOCALSTACK=true
      # Customer User Pool Configuration (from .env.local)
      - CUSTOMER_USER_POOL_ID=${CUSTOMER_USER_POOL_ID}
      - CUSTOMER_USER_POOL_CLIENT_ID=${CUSTOMER_USER_POOL_CLIENT_ID}
      - CUSTOMER_USER_POOL_REGION=us-east-1
      # Staff User Pool Configuration (from .env.local)
      - STAFF_USER_POOL_ID=${STAFF_USER_POOL_ID}
      - STAFF_USER_POOL_CLIENT_ID=${STAFF_USER_POOL_CLIENT_ID}
      - STAFF_USER_POOL_REGION=us-east-1
      # Auth Service Configuration
      - AUTH_SERVICE_ENDPOINT=http://backend:3001/auth
      - CUSTOMER_AUTH_ENDPOINT=http://backend:3001/auth/customer
      - STAFF_AUTH_ENDPOINT=http://backend:3001/auth/staff
      # Token Configuration
      - CUSTOMER_TOKEN_TTL=86400
      - STAFF_TOKEN_TTL=28800
      - JWT_ALGORITHM=RS256
      # Enhanced feature tables
      - ENGINES_TABLE=harborlist-engines
      - BILLING_ACCOUNTS_TABLE=harborlist-billing-accounts
      - TRANSACTIONS_TABLE=harborlist-transactions
      - FINANCE_CALCULATIONS_TABLE=harborlist-finance-calculations
      - MODERATION_QUEUE_TABLE=harborlist-moderation-queue
      - USER_GROUPS_TABLE=harborlist-user-groups
      # Payment processor configuration for local testing
      - STRIPE_SECRET_KEY=sk_test_local_development_key
      - STRIPE_WEBHOOK_SECRET=whsec_local_development_secret
      - PAYPAL_CLIENT_ID=local_paypal_client_id
      - PAYPAL_CLIENT_SECRET=local_paypal_client_secret
      - PAYMENT_PROCESSOR=stripe
    depends_on:
      - dynamodb-local
      - localstack
    networks:
      - harborlist-local
    labels:
      - "traefik.enable=true"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.backend-http.rule=Host(`local-api.harborlist.com`)"
      - "traefik.http.routers.backend-http.entrypoints=web"
      - "traefik.http.routers.backend-http.middlewares=https-redirect@file"
      # HTTPS router
      - "traefik.http.routers.backend-https.rule=Host(`local-api.harborlist.com`)"
      - "traefik.http.routers.backend-https.entrypoints=websecure"
      - "traefik.http.routers.backend-https.tls=true"
      - "traefik.http.routers.backend-https.service=backend"
      - "traefik.http.services.backend.loadbalancer.server.port=3001"
      - "traefik.http.services.backend.loadbalancer.server.scheme=http"

  # Local DynamoDB
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    ports:
      - "8000:8000"
    volumes:
      - dynamodb_data:/home/dynamodblocal/data
    working_dir: /home/dynamodblocal
    user: root
    command: [ "-jar", "DynamoDBLocal.jar", "-sharedDb", "-dbPath", "./data" ]
    networks:
      - harborlist-local

  # LocalStack Pro for S3, SES, CloudWatch, Cognito etc.
  localstack:
    image: localstack/localstack-pro:4.9.2
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    environment:
      - SERVICES=s3,ses,cloudwatch,logs,cognito-idp,cognito-identity,lambda,iam,apigateway
      - DEBUG=1
      - DATA_DIR=/var/lib/localstack
      - LAMBDA_EXECUTOR=local
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
      - SKIP_INFRA_DOWNLOADS=1
      # LocalStack Pro License
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN:-}
      # Cognito-specific configuration for dual auth pools
      - COGNITO_PROVIDER_DEVELOPER_USER_IDENTITY_POOL_ID=us-east-1:00000000-0000-0000-0000-000000000000
      - COGNITO_PROVIDER_DEVELOPER_USER_IDENTITY_POOL_NAME=harborlist_local_identity_pool
      - COGNITO_PROVIDER_DEVELOPER_USER_IDENTITY_POOL_REGION=us-east-1
      # Enhanced Cognito configuration
      - COGNITO_REMOVE_EXPIRED_TOKENS_SCHEDULE=0
      - COGNITO_JWT_SECRET=local-dev-cognito-secret-harborlist-2025
      # Lambda configuration for Cognito triggers and authorizers
      - LAMBDA_REMOTE_DOCKER=0
      - LAMBDA_DOCKER_NETWORK=harborlist-local
      - LAMBDA_RUNTIME_ENVIRONMENT_TIMEOUT=30
      # API Gateway configuration for authorizers
      - APIGATEWAY_ENFORCE_SECURE_CONNECTIONS=0
    volumes:
      - localstack_data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      - ./infrastructure/scripts:/opt/code/localstack/scripts:ro
    networks:
      - harborlist-local
    labels:
      - "traefik.enable=true"
      # S3 HTTPS proxy
      - "traefik.http.routers.s3-http.rule=Host(`s3.local.harborlist.com`)"
      - "traefik.http.routers.s3-http.entrypoints=web"
      - "traefik.http.routers.s3-http.middlewares=https-redirect@file"
      - "traefik.http.routers.s3-https.rule=Host(`s3.local.harborlist.com`)"
      - "traefik.http.routers.s3-https.entrypoints=websecure"
      - "traefik.http.routers.s3-https.tls=true"
      - "traefik.http.routers.s3-https.service=localstack"
      - "traefik.http.services.localstack.loadbalancer.server.port=4566"
      - "traefik.http.services.localstack.loadbalancer.server.scheme=http"
      # Cognito HTTPS proxy
      - "traefik.http.routers.cognito-http.rule=Host(`cognito.local.harborlist.com`)"
      - "traefik.http.routers.cognito-http.entrypoints=web"
      - "traefik.http.routers.cognito-http.middlewares=https-redirect@file"
      - "traefik.http.routers.cognito-https.rule=Host(`cognito.local.harborlist.com`)"
      - "traefik.http.routers.cognito-https.entrypoints=websecure"
      - "traefik.http.routers.cognito-https.tls=true"
      - "traefik.http.routers.cognito-https.service=localstack"

  # LocalStack initialization service
  localstack-init:
    image: alpine:latest
    depends_on:
      - localstack
    volumes:
      - ./tools:/tools
      - ./infrastructure/scripts:/scripts
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    networks:
      - harborlist-local
    command: >
      sh -c "
        apk add --no-cache curl aws-cli &&
        echo 'Waiting for LocalStack to be ready...' &&
        until curl -s http://localstack:4566/_localstack/health | grep -q '\"s3\": \"available\"'; do
          echo 'Waiting for LocalStack S3 service...'
          sleep 2
        done &&
        echo 'Waiting for Cognito service...' &&
        until curl -s http://localstack:4566/_localstack/health | grep -q '\"cognito-idp\": \"available\"'; do
          echo 'Waiting for LocalStack Cognito service...'
          sleep 2
        done &&
        echo 'Waiting for Lambda service...' &&
        until curl -s http://localstack:4566/_localstack/health | grep -q '\"lambda\": \"available\"'; do
          echo 'Waiting for LocalStack Lambda service...'
          sleep 2
        done &&
        echo 'LocalStack is ready. Running setup scripts...' &&
        chmod +x /tools/development/setup-s3-buckets.sh &&
        chmod +x /scripts/setup-local-cognito.sh &&
        chmod +x /scripts/setup-local-dynamodb.sh &&
        echo 'Setting up S3 buckets...' &&
        LOCALSTACK_ENDPOINT=http://localstack:4566 /tools/development/setup-s3-buckets.sh &&
        echo 'Setting up DynamoDB tables...' &&
        LOCALSTACK_ENDPOINT=http://localstack:4566 /scripts/setup-local-dynamodb.sh &&
        echo 'Setting up Cognito User Pools for dual auth...' &&
        LOCALSTACK_ENDPOINT=http://localstack:4566 /scripts/setup-local-cognito.sh &&
        echo 'LocalStack initialization completed successfully!'
      "

  # DynamoDB Admin UI
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin:latest
    ports:
      - "8001:8001"
    environment:
      - DYNAMO_ENDPOINT=http://dynamodb-local:8000
      - AWS_REGION=us-east-1
    depends_on:
      - dynamodb-local
    networks:
      - harborlist-local

  # Redis for caching (optional but useful for development)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - harborlist-local

  # Billing Service
  billing-service:
    build:
      context: .
      dockerfile: ./backend/Dockerfile.dev
      target: billing-service
    ports:
      - "3002:3002"
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/backend/node_modules
      - /workspace/packages/shared-types/node_modules
    environment:
      - NODE_ENV=development
      - ENVIRONMENT=local
      - DEPLOYMENT_TARGET=docker
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - JWT_SECRET=local-dev-secret-harborlist-2025
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=us-east-1
      - CORS_ORIGINS=https://local.harborlist.com,http://localhost:3000
      - API_BASE_URL=https://local-api.harborlist.com
      - FRONTEND_URL=https://local.harborlist.com
      - USERS_TABLE=harborlist-users
      - BILLING_ACCOUNTS_TABLE=harborlist-billing-accounts
      - TRANSACTIONS_TABLE=harborlist-transactions
      - AUDIT_LOGS_TABLE=harborlist-audit-logs
      # Payment processor configuration for local testing
      - STRIPE_SECRET_KEY=sk_test_local_development_key
      - STRIPE_WEBHOOK_SECRET=whsec_local_development_secret
      - PAYPAL_CLIENT_ID=local_paypal_client_id
      - PAYPAL_CLIENT_SECRET=local_paypal_client_secret
      - PAYMENT_PROCESSOR=stripe
      - SERVICE_PORT=3002
      # Cognito Configuration for LocalStack - Dual Auth Pools
      - COGNITO_ENDPOINT=http://localstack:4566
      - IS_LOCALSTACK=true
        - CUSTOMER_USER_POOL_ID=${CUSTOMER_USER_POOL_ID}
        - CUSTOMER_USER_POOL_CLIENT_ID=${CUSTOMER_USER_POOL_CLIENT_ID}
        - STAFF_USER_POOL_ID=${STAFF_USER_POOL_ID}
        - STAFF_USER_POOL_CLIENT_ID=${STAFF_USER_POOL_CLIENT_ID}
    depends_on:
      - dynamodb-local
    networks:
      - harborlist-local
    labels:
      - "traefik.enable=true"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.billing-http.rule=Host(`billing.local.harborlist.com`)"
      - "traefik.http.routers.billing-http.entrypoints=web"
      - "traefik.http.routers.billing-http.middlewares=https-redirect@file"
      # HTTPS router
      - "traefik.http.routers.billing-https.rule=Host(`billing.local.harborlist.com`)"
      - "traefik.http.routers.billing-https.entrypoints=websecure"
      - "traefik.http.routers.billing-https.tls=true"
      - "traefik.http.routers.billing-https.service=billing-service"
      - "traefik.http.services.billing-service.loadbalancer.server.port=3002"
      - "traefik.http.services.billing-service.loadbalancer.server.scheme=http"

  # Finance Service
  finance-service:
    build:
      context: .
      dockerfile: ./backend/Dockerfile.dev
      target: finance-service
    ports:
      - "3003:3003"
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/backend/node_modules
      - /workspace/packages/shared-types/node_modules
    environment:
      - NODE_ENV=development
      - ENVIRONMENT=local
      - DEPLOYMENT_TARGET=docker
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - JWT_SECRET=local-dev-secret-harborlist-2025
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=us-east-1
      - CORS_ORIGINS=https://local.harborlist.com,http://localhost:3000
      - API_BASE_URL=https://local-api.harborlist.com
      - FRONTEND_URL=https://local.harborlist.com
      - LISTINGS_TABLE=harborlist-listings
      - USERS_TABLE=harborlist-users
      - FINANCE_CALCULATIONS_TABLE=harborlist-finance-calculations
      - SERVICE_PORT=3003
      # Cognito Configuration for LocalStack - Dual Auth Pools
      - COGNITO_ENDPOINT=http://localstack:4566
      - IS_LOCALSTACK=true
        - CUSTOMER_USER_POOL_ID=${CUSTOMER_USER_POOL_ID}
        - CUSTOMER_USER_POOL_CLIENT_ID=${CUSTOMER_USER_POOL_CLIENT_ID}
        - STAFF_USER_POOL_ID=${STAFF_USER_POOL_ID}
        - STAFF_USER_POOL_CLIENT_ID=${STAFF_USER_POOL_CLIENT_ID}
    depends_on:
      - dynamodb-local
    networks:
      - harborlist-local
    labels:
      - "traefik.enable=true"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.finance-http.rule=Host(`finance.local.harborlist.com`)"
      - "traefik.http.routers.finance-http.entrypoints=web"
      - "traefik.http.routers.finance-http.middlewares=https-redirect@file"
      # HTTPS router
      - "traefik.http.routers.finance-https.rule=Host(`finance.local.harborlist.com`)"
      - "traefik.http.routers.finance-https.entrypoints=websecure"
      - "traefik.http.routers.finance-https.tls=true"
      - "traefik.http.routers.finance-https.service=finance-service"
      - "traefik.http.services.finance-service.loadbalancer.server.port=3003"
      - "traefik.http.services.finance-service.loadbalancer.server.scheme=http"

  # SMTP4Dev for local email testing (future feature: customer stats emails)
  smtp4dev:
    image: rnwood/smtp4dev:v3
    ports:
      - "5001:80" # Web UI (changed from 5000 to avoid conflict with macOS Control Center)
      - "2525:25" # SMTP port
    environment:
      - ServerOptions__HostName=smtp4dev
    networks:
      - harborlist-local
    labels:
      - "traefik.enable=true"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.smtp4dev-http.rule=Host(`mail.local.harborlist.com`)"
      - "traefik.http.routers.smtp4dev-http.entrypoints=web"
      - "traefik.http.routers.smtp4dev-http.middlewares=https-redirect@file"
      # HTTPS router
      - "traefik.http.routers.smtp4dev-https.rule=Host(`mail.local.harborlist.com`)"
      - "traefik.http.routers.smtp4dev-https.entrypoints=websecure"
      - "traefik.http.routers.smtp4dev-https.tls=true"
      - "traefik.http.routers.smtp4dev-https.service=smtp4dev"
      - "traefik.http.services.smtp4dev.loadbalancer.server.port=80"
      - "traefik.http.services.smtp4dev.loadbalancer.server.scheme=http"

networks:
  harborlist-local:
    driver: bridge

volumes:
  dynamodb_data:
    driver: local
  localstack_data:
    driver: local
  redis_data:
    driver: local
  traefik_certs:
    driver: local
