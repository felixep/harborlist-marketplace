# HarborList Deployment Tools

This directory contains automated deployment tools for the HarborList marketplace application.

## üìÅ Contents

- `deploy.sh` - Main deployment automation script
- `cleanup.sh` - Environment cleanup and resource destruction script
- `verify-deployment.sh` - Deployment verification and health checks
- `README.md` - This documentation file

## üöÄ Quick Start

```bash
# Deploy local development environment
./deploy.sh local

# Deploy to AWS environments  
./deploy.sh dev      # Development
./deploy.sh staging  # Staging
./deploy.sh prod     # Production
```

## üìã Prerequisites

### For Local Development (`./deploy.sh local`)

**Required Software:**
- Docker (v20.10 or later)
- Docker Compose (v2.0 or later)

**System Configuration:**
- Host file entries in `/etc/hosts`:
  ```
  127.0.0.1 local.harborlist.com
  127.0.0.1 local-api.harborlist.com
  127.0.0.1 traefik.local.harborlist.com
  ```

**SSL Certificates:**
- Local SSL certificates must be present in `certs/local/`
- Certificates are automatically generated by the project setup scripts

### For AWS Deployments

**Required Software:**
- AWS CLI (v2.0 or later)
- AWS CDK (v2.0 or later)
- Node.js (v18 or later)

**AWS Configuration:**
- Valid AWS credentials configured (`aws configure` or environment variables)
- CDK bootstrapped for target region: `cdk bootstrap`
- Appropriate IAM permissions for resource creation

## üåê Local Development Environment

The local deployment uses the **enhanced profile** by default, which includes:

### Services Deployed
- **Frontend** - React application with Vite dev server
- **Backend** - Express.js API server wrapping Lambda functions
- **Database** - DynamoDB Local for development
- **Cache** - Redis for session and data caching
- **Reverse Proxy** - Traefik with SSL termination
- **AWS Services** - LocalStack for S3, SES simulation

### Access Points

**Primary Access (Custom Domains):**
- üåê **Frontend**: https://local.harborlist.com
- üîß **Backend API**: https://local-api.harborlist.com

**Direct Access (Bypass Traefik):**
- üåê **Frontend**: http://localhost:3000
- üîß **Backend API**: http://localhost:3001

**Management & Monitoring:**
- üìä **Traefik Dashboard**: http://localhost:8088
- üóÑÔ∏è **DynamoDB Local**: http://localhost:8000
- üîç **DynamoDB Admin**: http://localhost:8001
- üì¶ **LocalStack**: http://localhost:4566

## üèóÔ∏è Architecture

### Enhanced Profile Features
- **SSL Termination**: Automatic HTTPS with self-signed certificates
- **Custom Domains**: Production-like domain routing
- **Rate Limiting**: API rate limiting middleware
- **Security Headers**: HTTPS redirects and security headers
- **Service Discovery**: Automatic Docker service discovery

### Authentication System
The deployment includes a **deployment-target-aware** authentication system:

- **Docker Environment**: JWT secrets from environment variables
- **AWS Environment**: JWT secrets from AWS Secrets Manager  
- **Single Codebase**: Same code works in both environments

## üìù Usage Examples

### Basic Deployment
```bash
# Deploy with all default settings
./deploy.sh local
```

### Managing the Deployment
```bash
# View logs
docker-compose -f docker-compose.local.yml --profile enhanced logs -f

# Stop services
docker-compose -f docker-compose.local.yml --profile enhanced down

# Rebuild and restart
docker-compose -f docker-compose.local.yml --profile enhanced up --build -d
```

### Development Workflow
```bash
# 1. Deploy the environment
./deploy.sh local

# 2. Access the application
open https://local.harborlist.com

# 3. Monitor logs during development
docker-compose -f docker-compose.local.yml --profile enhanced logs -f backend

# 4. Clean shutdown when done
docker-compose -f docker-compose.local.yml --profile enhanced down
```

### AWS Deployment Examples
```bash
# Deploy to development environment
./deploy.sh dev

# Deploy to production
./deploy.sh prod

# Verify specific stack deployment
./verify-deployment.sh harborlist-dev-stack

# Verify all deployments
./verify-deployment.sh
```

## üßπ Environment Cleanup

### Cleanup Script (`cleanup.sh`)
‚ö†Ô∏è **DESTRUCTIVE OPERATION** - Use with extreme caution!

The cleanup script provides complete environment destruction for both local and AWS environments.

#### Basic Usage
```bash
# Clean up local development environment
./cleanup.sh local

# Clean up AWS environments
./cleanup.sh dev       # Development environment
./cleanup.sh staging   # Staging environment  
./cleanup.sh prod      # Production environment (requires extra confirmation)
```

#### Force Mode (Skip Confirmations)
```bash
# Skip all confirmation prompts
./cleanup.sh dev --force
./cleanup.sh staging --force

# Production still requires confirmation even in force mode
./cleanup.sh prod --force
```

#### What Gets Destroyed

**Local Environment:**
- ‚úÖ All Docker containers and images
- ‚úÖ All Docker volumes and networks  
- ‚úÖ Local SSL certificates
- ‚úÖ Development data directories
- ‚úÖ Log files

**AWS Environments:**
- ‚úÖ All CDK stacks and resources
- ‚úÖ S3 buckets and ALL their contents
- ‚úÖ DynamoDB tables
- ‚úÖ Lambda functions
- ‚úÖ API Gateway APIs
- ‚úÖ CloudWatch Log Groups
- ‚úÖ CloudFormation stacks

#### Safety Features
- **Multi-level confirmations** (especially for production)
- **Comprehensive logging** with timestamped log files
- **Resource validation** before destruction
- **Environment-specific safety checks**
- **Prerequisites validation**

#### Production Safeguards
Production cleanup requires typing `DESTROY PRODUCTION` (case-sensitive) to confirm the destructive operation.

#### Cleanup Examples
```bash
# Safe local cleanup with confirmation
./cleanup.sh local

# AWS development cleanup with logging
./cleanup.sh dev
# Creates: cleanup_YYYYMMDD_HHMMSS.log

# Emergency production cleanup (still requires confirmation)
./cleanup.sh prod --force
```

#### Post-Cleanup Verification
The script automatically verifies resource destruction and provides a comprehensive summary of cleaned resources.

## üîß Configuration

### Environment Variables
The deployment script automatically configures:

- `DEPLOYMENT_TARGET=docker` for local environments
- `DEPLOYMENT_TARGET=aws` for cloud environments
- Database connection strings for local services
- CORS origins for local domains

### Custom Domains Configuration
The Traefik configuration enables:

- **HTTPS Redirects**: HTTP automatically redirects to HTTPS
- **SSL Certificates**: Self-signed certificates for local development
- **Service Discovery**: Automatic routing based on Docker labels
- **Load Balancing**: Built-in load balancing for scaled services

## üìä Monitoring & Debugging

### Logs
All deployment activities are logged to:
```
deployment_YYYYMMDD_HHMMSS.log
```

### Health Checks
Verify deployment health:
```bash
# Backend API health
curl -k https://local-api.harborlist.com/health

# Frontend accessibility  
curl -k https://local.harborlist.com

# Traefik API
curl http://localhost:8088/api/version
```

### Common Issues

**Custom domains not resolving:**
1. Verify `/etc/hosts` entries
2. Clear DNS cache: `sudo dscacheutil -flushcache` (macOS)
3. Check Traefik logs: `docker-compose logs traefik`

**SSL certificate errors:**
1. Accept self-signed certificates in browser
2. Verify certificates exist in `certs/local/`
3. Regenerate certificates if needed

**Services not starting:**
1. Check Docker daemon is running
2. Verify no port conflicts
3. Check logs: `docker-compose logs <service-name>`

## üîÑ Profiles

### Enhanced Profile (Default)
- **Services**: All services including Traefik
- **Domains**: Custom domain support
- **SSL**: HTTPS with self-signed certificates
- **Use Case**: Full production-like development environment

### Basic Profile (Legacy)
- **Services**: Core services only (no Traefik)
- **Access**: Direct port access only
- **Use Case**: Minimal development setup

To use basic profile:
```bash
# Manually override to basic profile
docker-compose -f docker-compose.local.yml --profile basic up -d
```

## üìö Scripts Overview

### üöÄ **deploy.sh**
**Purpose**: Unified deployment script for local Docker and AWS environments
- **Usage**: `./deploy.sh <environment>`
- **Environments**: local, dev, staging, prod
- **Features**:
  - Enhanced profile by default with Traefik routing
  - Deployment-target-aware authentication system
  - Custom domain support for local development
  - Comprehensive logging and error handling
  - Docker prerequisite validation
  - Service health checks and status monitoring

### ‚úÖ **verify-deployment.sh**
**Purpose**: Comprehensive deployment verification and health checks
- **Usage**: `./verify-deployment.sh [stack-name]`
- **Checks**:
  - Stack deployment status
  - API Gateway endpoints
  - DynamoDB table availability
  - S3 bucket configuration
  - Lambda function health
  - CloudWatch alarms
- **Output**: Detailed verification report with pass/fail status

## üìö Additional Resources

- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Traefik Documentation](https://doc.traefik.io/traefik/)
- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/)
- [Main Infrastructure README](../../infrastructure/README.md)
- [Monitoring Scripts](../monitoring/README.md)
- [Cost Management](../cost-management/README.md)
- [Project Main README](../../README.md)

## ü§ù Contributing

When modifying deployment scripts:

1. **Test Locally**: Always test changes with `./deploy.sh local`
2. **Update Documentation**: Update this README for any new features
3. **Log Changes**: Ensure all operations are properly logged
4. **Error Handling**: Add appropriate error handling and validation
5. **Version Control**: Update version information in script headers

## üìÑ License

This deployment tooling is part of the HarborList project. See the main project README for license information.